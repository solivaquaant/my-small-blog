"use strict";(self.webpackChunkmy_own_blog=self.webpackChunkmy_own_blog||[]).push([[4945],{28453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>l});var s=i(96540);const t={},r=s.createContext(t);function o(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),s.createElement(r.Provider,{value:n},e.children)}},44012:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>m,frontMatter:()=>o,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"sysmon-splunk/integrity/integrity","title":"Detecting suspicious file operations in critical Windows directories","description":"Overview","source":"@site/docs/sysmon-splunk/integrity/integrity.mdx","sourceDirName":"sysmon-splunk/integrity","slug":"/sysmon-splunk/integrity/","permalink":"/my-small-blog/docs/sysmon-splunk/integrity/","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Lab setup","permalink":"/my-small-blog/docs/sysmon-splunk/installation/"},"next":{"title":"Investigating suspicious PowerShell activity","permalink":"/my-small-blog/docs/sysmon-splunk/powershell/"}}');var t=i(74848),r=i(28453);const o={},l="Detecting suspicious file operations in critical Windows directories",a={},c=[{value:"Overview",id:"overview",level:2},{value:"Execution steps",id:"execution-steps",level:2},{value:"Create a suspicious executable",id:"create-a-suspicious-executable",level:3},{value:"Modify an existing file",id:"modify-an-existing-file",level:3},{value:"Delete a critical file",id:"delete-a-critical-file",level:3},{value:"Log analysis in Splunk",id:"log-analysis-in-splunk",level:2},{value:"Detect new file creation",id:"detect-new-file-creation",level:3},{value:"Detect file modifications",id:"detect-file-modifications",level:3}];function d(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",p:"p",pre:"pre",strong:"strong",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"detecting-suspicious-file-operations-in-critical-windows-directories",children:"Detecting suspicious file operations in critical Windows directories"})}),"\n",(0,t.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsx)(n.p,{children:"Monitoring file operations within critical system directories is essential for detecting early signs of compromise.\r\nAttackers often create, modify, or delete files in these locations to execute malicious payloads, tamper with configurations, or disrupt system functionality."}),"\n",(0,t.jsxs)(n.p,{children:["In this blog post, we simulate file creation, modification, and deletion events using ",(0,t.jsx)(n.em,{children:"PowerShell"})," and demonstrate how to detect and analyze these activities with Sysmon and Splunk.\r\nOur goal is to uncover unauthorized actions that may indicate malware behavior or insider threats."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"execution-steps",children:"Execution steps"}),"\n",(0,t.jsx)(n.h3,{id:"create-a-suspicious-executable",children:"Create a suspicious executable"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"echo MaliciousContent > C:\\Windows\\System32\\malicious.exe\n"})}),"\n",(0,t.jsxs)(n.p,{children:["This command creates a new file named ",(0,t.jsx)(n.code,{children:"malicious.ex"}),"e in the ",(0,t.jsx)(n.strong,{children:"System32"})," directory - an immediate red flag, as this location should not contain user-generated executables."]}),"\n",(0,t.jsx)(n.h3,{id:"modify-an-existing-file",children:"Modify an existing file"}),"\n",(0,t.jsxs)(n.p,{children:["Appending content to ",(0,t.jsx)(n.code,{children:"config.sys"})," simulates tampering with a critical system file."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"echo AlteredContent >> C:\\Windows\\System32\\config.sys\n"})}),"\n",(0,t.jsx)(n.h3,{id:"delete-a-critical-file",children:"Delete a critical file"}),"\n",(0,t.jsx)(n.p,{children:"Deleting system DLLs can cause application crashes, weaken defenses, or disrupt services"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"del C:\\Windows\\System32\\important.dll\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"log-analysis-in-splunk",children:"Log analysis in Splunk"}),"\n",(0,t.jsxs)(n.p,{children:["To detect and analyze these activities, we rely on Sysmon ",(0,t.jsx)(n.strong,{children:"Event ID 11"}),", which records file creation events-including those triggered by modifications and deletions (depending on how the file system behaves)."]}),"\n",(0,t.jsx)(n.h3,{id:"detect-new-file-creation",children:"Detect new file creation"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'index=sysmon_logs EventCode=11 TargetFilename="*System32*" OR TargetFilename="*Program Files*" \r\n| stats count by TargetFilename, Image, User\n'})}),"\n",(0,t.jsxs)(n.p,{children:["This SPL query filters for file creation events in key system directories.\r\nThe ",(0,t.jsx)(n.code,{children:"stats count"})," command aggregates entries by file path, the process responsible, and the user."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Log from Splunk:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"07/25/2025 07:37:47 AM\r\nLogName=Microsoft-Windows-Sysmon/Operational\r\nEventCode=11\r\nEventType=4\r\nComputerName=DESKTOP-R6K3C8S\r\nUser=NOT_TRANSLATED\r\nSid=S-1-5-18\r\nSidType=0\r\nSourceName=Microsoft-Windows-Sysmon\r\nType=Information\r\nRecordNumber=8111\r\nKeywords=None\r\nTaskCategory=File created (rule: FileCreate)\r\nOpCode=Info\r\nMessage=File created:\r\nRuleName: EXE\r\nUtcTime: 2025-07-25 14:37:47.128\r\nProcessGuid: {d6c4500c-701e-6883-6503-000000000700}\r\nProcessId: 1412\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nTargetFilename: C:\\Windows\\System32\\malicious.exe\r\nCreationUtcTime: 2025-07-25 14:37:47.128\r\nUser: DESKTOP-R6K3C8S\\thait\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Event description:"})," A file named ",(0,t.jsx)(n.code,{children:"malicious.exe"})," was created by PowerShell in the ",(0,t.jsx)(n.strong,{children:"System32"})," directory, likely indicating an attempt to plant an executable in a trusted location."]}),"\n",(0,t.jsx)(n.h3,{id:"detect-file-modifications",children:"Detect file modifications"}),"\n",(0,t.jsxs)(n.p,{children:["While Sysmon doesn't explicitly log file modification events, appending data to an existing file may still trigger a ",(0,t.jsx)(n.strong,{children:"FileCreate"})," event if the file handle is treated as new.\r\nThe same SPL query can be reused:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'index=sysmon_logs EventCode=11 TargetFilename="*System32*" \r\n| stats count by TargetFilename, Image, User\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Log from Splunk:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"07/25/2025 07:40:45 AM\r\nLogName=Microsoft-Windows-Sysmon/Operational\r\nEventCode=11\r\nEventType=4\r\nComputerName=DESKTOP-R6K3C8S\r\nUser=NOT_TRANSLATED\r\nSid=S-1-5-18\r\nSidType=0\r\nSourceName=Microsoft-Windows-Sysmon\r\nType=Information\r\nRecordNumber=8132\r\nKeywords=None\r\nTaskCategory=File created (rule: FileCreate)\r\nOpCode=Info\r\nMessage=File created:\r\nRuleName: -\r\nUtcTime: 2025-07-25 14:40:45.034\r\nProcessGuid: {d6c4500c-701e-6883-6503-000000000700}\r\nProcessId: 1412\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nTargetFilename: C:\\Windows\\System32\\config.sys\r\nCreationUtcTime: 2025-07-25 14:40:45.034\r\nUser: DESKTOP-R6K3C8S\\thait\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Event description:"})," PowerShell was used to append data to ",(0,t.jsx)(n.code,{children:"config.sys"}),", a legacy system configuration file."]})]})}function m(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}}}]);