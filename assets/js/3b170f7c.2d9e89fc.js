"use strict";(self.webpackChunkmy_own_blog=self.webpackChunkmy_own_blog||[]).push([[1392],{28453:(e,s,r)=>{r.d(s,{R:()=>o,x:()=>c});var n=r(96540);const t={},i=n.createContext(t);function o(e){const s=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),n.createElement(i.Provider,{value:s},e.children)}},81289:(e,s,r)=>{r.d(s,{A:()=>n});const n=r.p+"assets/images/cor-113f3a7d9610bbd5daf1874e3fa74dc8.png"},84271:(e,s,r)=>{r.r(s),r.d(s,{assets:()=>a,contentTitle:()=>c,default:()=>u,frontMatter:()=>o,metadata:()=>n,toc:()=>l});const n=JSON.parse('{"id":"sysmon-splunk/registry/registry","title":"Tracking suspicious Windows Registry changes","description":"Overview","source":"@site/docs/sysmon-splunk/registry/registry.mdx","sourceDirName":"sysmon-splunk/registry","slug":"/sysmon-splunk/registry/","permalink":"/my-small-blog/docs/sysmon-splunk/registry/","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Detecting RDP brute-force attacks","permalink":"/my-small-blog/docs/sysmon-splunk/rdp-brute-force/"},"next":{"title":"Dectecting suspicious scheduled tasks","permalink":"/my-small-blog/docs/sysmon-splunk/scheduled-task/"}}');var t=r(74848),i=r(28453);const o={},c="Tracking suspicious Windows Registry changes",a={},l=[{value:"Overview",id:"overview",level:2},{value:"Execution steps",id:"execution-steps",level:2},{value:"Simulate registry-based persistence",id:"simulate-registry-based-persistence",level:3},{value:"Simulate Registry Key deletion",id:"simulate-registry-key-deletion",level:3},{value:"Log analysis in Splunk",id:"log-analysis-in-splunk",level:2},{value:"Detect Registry persistence entry creation",id:"detect-registry-persistence-entry-creation",level:3},{value:"Detect Registry key deletions",id:"detect-registry-key-deletions",level:3},{value:"Correlate Registry events with process execution",id:"correlate-registry-events-with-process-execution",level:3}];function d(e){const s={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.header,{children:(0,t.jsx)(s.h1,{id:"tracking-suspicious-windows-registry-changes",children:"Tracking suspicious Windows Registry changes"})}),"\n",(0,t.jsx)(s.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.em,{children:"The Windows Registry"})," is a common target for adversaries looking to establish persistence, modify security configurations, or stealthily execute malware.\r\nRegistry-based persistence techniques are particularly dangerous because they allow malicious code to survive system reboots and execute without raising immediate alarms."]}),"\n",(0,t.jsx)(s.p,{children:"In this blog post, we simulate suspicious registry modifications and deletions, then walk through how to detect and investigate them using Sysmon and Splunk.\r\nYou'll learn how to identify key events tied to registry persistence and how to correlate them with process activity to build effective detection strategies."}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"execution-steps",children:"Execution steps"}),"\n",(0,t.jsx)(s.h3,{id:"simulate-registry-based-persistence",children:"Simulate registry-based persistence"}),"\n",(0,t.jsx)(s.p,{children:"We create a registry key under the Run path to auto-launch a malicious binary every time a user logs in:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:'New-ItemProperty -Path "HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" -Name "malware" -Value "C:\\malware.exe"\n'})}),"\n",(0,t.jsx)(s.p,{children:"This PowerShell command adds a new value named malware to the current user's Run registry key."}),"\n",(0,t.jsx)("div",{style:{width:"100%",margin:"0 auto"},children:(0,t.jsx)("img",{src:r(85335).A,style:{width:"100%",height:"auto"}})}),"\n",(0,t.jsx)(s.h3,{id:"simulate-registry-key-deletion",children:"Simulate Registry Key deletion"}),"\n",(0,t.jsx)(s.p,{children:"Next, we delete a registry key to mimic tampering or cleanup behavior:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:'Remove-Item -Path "HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\MalwareSimulation"\n'})}),"\n",(0,t.jsx)(s.p,{children:"This represents an attacker removing traces of their presence or deactivating prior persistence mechanisms."}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"log-analysis-in-splunk",children:"Log analysis in Splunk"}),"\n",(0,t.jsx)(s.h3,{id:"detect-registry-persistence-entry-creation",children:"Detect Registry persistence entry creation"}),"\n",(0,t.jsxs)(s.p,{children:["To identify suspicious additions to the registry, especially under ",(0,t.jsx)(s.strong,{children:"Run"})," keys:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:'index=sysmon_logs EventCode=13 | where like(TargetObject, "%Run%")\n'})}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:"EventCode=13"}),' corresponds to Sysmon\'s Registry Value Set events.\r\nThe filter like(TargetObject, "%Run%") focuses on keys typically used for persistence.']}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Log from Splunk:"})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:"07/25/2025 04:50:13 AM\r\nLogName=Microsoft-Windows-Sysmon/Operational\r\nEventCode=13\r\nEventType=4\r\nComputerName=DESKTOP-R6K3C8S\r\nUser=NOT_TRANSLATED\r\nSid=S-1-5-18\r\nSidType=0\r\nSourceName=Microsoft-Windows-Sysmon\r\nType=Information\r\nRecordNumber=5650\r\nKeywords=None\r\nTaskCategory=Registry value set (rule: RegistryEvent)\r\nOpCode=Info\r\nMessage=Registry value set:\r\nRuleName: T1060,RunKey\r\nEventType: SetValue\r\nUtcTime: 2025-07-25 11:50:13.486\r\nProcessGuid: {d6c4500c-6edd-6883-2303-000000000700}\r\nProcessId: 2676\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nTargetObject: HKU\\S-1-5-21-3305846525-3407497656-2755245524-1001\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\\malware\r\nDetails: C:\\malware.exe\r\nUser: DESKTOP-R6K3C8S\\thait\n"})}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Event description:"})," A new registry value was created under the Run key by ",(0,t.jsx)(s.code,{children:"powershell.exe"}),", pointing to ",(0,t.jsx)(s.code,{children:"C:\\malware.exe"}),"."]}),"\n",(0,t.jsx)(s.h3,{id:"detect-registry-key-deletions",children:"Detect Registry key deletions"}),"\n",(0,t.jsx)(s.p,{children:"To uncover attempts to remove registry keys:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:"index=sysmon_logs EventCode=12 | stats count by TargetObject, Image, User\n"})}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:"EventCode=12"})," tracks registry key creation and deletion.\r\nUsing ",(0,t.jsx)(s.code,{children:"stats count"})," groups results for easy aggregation by registry path, executable, and user."]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Log from Splunk:"})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:"07/25/2025 04:54:43 AM\r\nLogName=Microsoft-Windows-Sysmon/Operational\r\nEventCode=12\r\nEventType=4\r\nComputerName=DESKTOP-R6K3C8S\r\nUser=NOT_TRANSLATED\r\nSid=S-1-5-18\r\nSidType=0\r\nSourceName=Microsoft-Windows-Sysmon\r\nType=Information\r\nRecordNumber=5703\r\nKeywords=None\r\nTaskCategory=Registry object added or deleted (rule: RegistryEvent)\r\nOpCode=Info\r\nMessage=Registry object added or deleted:\r\nRuleName: T1060,RunKey\r\nEventType: DeleteKey\r\nUtcTime: 2025-07-25 11:54:43.358\r\nProcessGuid: {d6c4500c-701e-6883-6503-000000000700}\r\nProcessId: 1412\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nTargetObject: HKU\\S-1-5-21-3305846525-3407497656-2755245524-1001\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\\MalwareSimulation\r\nUser: DESKTOP-R6K3C8S\\thait\n"})}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Event description:"})," A registry key related to a simulated persistence mechanism was deleted via ",(0,t.jsx)(s.code,{children:"powershell.exe"}),"."]}),"\n",(0,t.jsx)(s.h3,{id:"correlate-registry-events-with-process-execution",children:"Correlate Registry events with process execution"}),"\n",(0,t.jsx)(s.p,{children:"To identify which processes were responsible for modifying the registry:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:'index=sysmon_logs EventCode=1 Image="*powershell.exe"\n'})}),"\n",(0,t.jsxs)(s.p,{children:["This pulls ",(0,t.jsx)(s.code,{children:"EventCode=1"})," logs - which indicate process creation - specifically for ",(0,t.jsx)(s.code,{children:"powershell.exe"}),".\r\nBy correlating these with registry modification events, we can tie user activity to specific registry changes."]}),"\n",(0,t.jsx)("div",{style:{width:"100%",margin:"0 auto"},children:(0,t.jsx)("img",{src:r(81289).A,style:{width:"100%",height:"auto"}})})]})}function u(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},85335:(e,s,r)=>{r.d(s,{A:()=>n});const n=r.p+"assets/images/mal-2e56ce4a199f4c888fd3ea71734e2840.png"}}]);