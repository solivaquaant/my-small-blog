"use strict";(self.webpackChunkmy_own_blog=self.webpackChunkmy_own_blog||[]).push([[7818],{641:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"sysmon-splunk/powershell/powershell","title":"Investigating suspicious PowerShell activity","description":"Overview","source":"@site/docs/sysmon-splunk/powershell/powershell.mdx","sourceDirName":"sysmon-splunk/powershell","slug":"/sysmon-splunk/powershell/","permalink":"/my-small-blog/docs/sysmon-splunk/powershell/","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Detecting suspicious file operations in critical Windows directories","permalink":"/my-small-blog/docs/sysmon-splunk/integrity/"},"next":{"title":"Detecting RDP brute-force attacks","permalink":"/my-small-blog/docs/sysmon-splunk/rdp-brute-force/"}}');var o=i(4848),r=i(8453);const t={},l="Investigating suspicious PowerShell activity",c={},a=[{value:"Overview",id:"overview",level:2},{value:"Execution steps",id:"execution-steps",level:2},{value:"Configure PowerShell Logging in Splunk",id:"configure-powershell-logging-in-splunk",level:3},{value:"Simulate suspicious PowerShell activity",id:"simulate-suspicious-powershell-activity",level:3},{value:"Log analysis in Splunk",id:"log-analysis-in-splunk",level:2},{value:"Detect file creation events via Sysmon",id:"detect-file-creation-events-via-sysmon",level:3}];function d(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",p:"p",pre:"pre",strong:"strong",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"investigating-suspicious-powershell-activity",children:"Investigating suspicious PowerShell activity"})}),"\n",(0,o.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.em,{children:"PowerShell"})," is a powerful administrative tool built into Windows-but its flexibility also makes it a favorite among attackers.\r\nFrom fileless malware to encoded scripts, PowerShell is often leveraged in post-exploitation scenarios, lateral movement, and data exfiltration."]}),"\n",(0,o.jsxs)(n.p,{children:["In this post, we walk through setting up PowerShell logging in Splunk, simulating suspicious activity using ",(0,o.jsx)(n.code,{children:"Invoke-WebRequest"}),", and detecting that behavior using Sysmon logs and SPL queries.\r\nOur focus is on identifying anomalous script executions and file downloads that may indicate compromise."]}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h2,{id:"execution-steps",children:"Execution steps"}),"\n",(0,o.jsx)(n.h3,{id:"configure-powershell-logging-in-splunk",children:"Configure PowerShell Logging in Splunk"}),"\n",(0,o.jsxs)(n.p,{children:["To monitor PowerShell activity, first create a new index on your Splunk Server: ",(0,o.jsx)(n.code,{children:"powershell_logs"})]}),"\n",(0,o.jsx)("div",{style:{width:"100%",margin:"0 auto"},children:(0,o.jsx)("img",{src:i(8547).A,style:{width:"100%",height:"auto"}})}),"\n",(0,o.jsxs)(n.p,{children:["Then, on the Splunk Forwarder machine, configure data ingestion by modifying the ",(0,o.jsx)(n.code,{children:"inputs.conf"})," file:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"[WinEventLog://Microsoft-Windows-PowerShell/Operational]\r\ndisabled = 0\r\nindex = powershell_logs\r\nsourcetype = WinEventLog:PowerShell\n"})}),"\n",(0,o.jsx)(n.p,{children:"Next, add a file monitor for the PowerShell log file:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'splunk add monitor "C:\\Windows\\System32\\winevt\\Logs\\Microsoft-Windows-PowerShell%4Operational.evtx"\n'})}),"\n",(0,o.jsx)(n.p,{children:"Restart the Splunk Forwarder and check on the Splunk Server to see if PowerShell logs are being received."}),"\n",(0,o.jsx)(n.h3,{id:"simulate-suspicious-powershell-activity",children:"Simulate suspicious PowerShell activity"}),"\n",(0,o.jsx)(n.p,{children:"Download a suspicious file from the Internet using PowerShell:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'Invoke-WebRequest -Uri "https://secure.eicar.org/eicar.com.txt" -OutFile "$env:USERPROFILE\\Downloads\\eicar.com.txt"\n'})}),"\n",(0,o.jsx)(n.h2,{id:"log-analysis-in-splunk",children:"Log analysis in Splunk"}),"\n",(0,o.jsx)(n.h3,{id:"detect-file-creation-events-via-sysmon",children:"Detect file creation events via Sysmon"}),"\n",(0,o.jsx)(n.p,{children:"To catch new file creations that may stem from PowerShell downloads, use the following SPL query:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:'index="sysmon_logs" EventCode=11 TargetFilename="*eicar.com.txt*"\n'})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"EventCode=11"})," in Sysmon corresponds to ",(0,o.jsx)(n.strong,{children:"FileCreate"})," events.\r\nThis search filters those events for files with the name ",(0,o.jsx)(n.code,{children:"eicar.com.txt"}),"."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Log from Splunk:"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"07/25/2025 06:18:38 AM\r\nLogName=Microsoft-Windows-Sysmon/Operational\r\nEventCode=11\r\nEventType=4\r\nComputerName=DESKTOP-R6K3C8S\r\nUser=NOT_TRANSLATED\r\nSid=S-1-5-18\r\nSidType=0\r\nSourceName=Microsoft-Windows-Sysmon\r\nType=Information\r\nRecordNumber=7958\r\nKeywords=None\r\nTaskCategory=File created (rule: FileCreate)\r\nOpCode=Info\r\nMessage=File created:\r\nRuleName: Downloads\r\nUtcTime: 2025-07-25 13:18:38.509\r\nProcessGuid: {d6c4500c-701e-6883-6503-000000000700}\r\nProcessId: 1412\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nTargetFilename: C:\\Users\\thait\\Downloads\\eicar.com.txt\r\nCreationUtcTime: 2025-07-25 13:18:38.509\r\nUser: DESKTOP-R6K3C8S\\thait\n"})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Event description:"})," A new file named ",(0,o.jsx)(n.code,{children:"eicar.com.txt"})," was created in the Downloads folder by a PowerShell process."]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>t,x:()=>l});var s=i(6540);const o={},r=s.createContext(o);function t(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:t(e.components),s.createElement(r.Provider,{value:n},e.children)}},8547:(e,n,i)=>{i.d(n,{A:()=>s});const s=i.p+"assets/images/index-48298343eef77123026010dc11b0f51e.png"}}]);