"use strict";(self.webpackChunkmy_own_blog=self.webpackChunkmy_own_blog||[]).push([[1890],{9145:(e,s,n)=>{n.d(s,{A:()=>r});const r=n.p+"assets/images/cor-8db3b26de3d4521348ba671b51aa383a.png"},28453:(e,s,n)=>{n.d(s,{R:()=>o,x:()=>a});var r=n(96540);const t={},i=r.createContext(t);function o(e){const s=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function a(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),r.createElement(i.Provider,{value:s},e.children)}},86907:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"sysmon-splunk/scheduled-task/scheduled-task","title":"Dectecting suspicious scheduled tasks","description":"Overview","source":"@site/docs/sysmon-splunk/scheduled-task/scheduled-task.mdx","sourceDirName":"sysmon-splunk/scheduled-task","slug":"/sysmon-splunk/scheduled-task/","permalink":"/my-small-blog/docs/sysmon-splunk/scheduled-task/","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Tracking suspicious Windows Registry changes","permalink":"/my-small-blog/docs/sysmon-splunk/registry/"}}');var t=n(74848),i=n(28453);const o={},a="Dectecting suspicious scheduled tasks",c={},d=[{value:"Overview",id:"overview",level:2},{value:"Execution steps",id:"execution-steps",level:2},{value:"Create a suspicious scheduled task:",id:"create-a-suspicious-scheduled-task",level:3},{value:"Modify an existing task:",id:"modify-an-existing-task",level:3},{value:"Execute the task:",id:"execute-the-task",level:3},{value:"Delete the task:",id:"delete-the-task",level:3},{value:"Log analysis in Splunk",id:"log-analysis-in-splunk",level:2},{value:"Detect task creation",id:"detect-task-creation",level:3},{value:"Detect task modification",id:"detect-task-modification",level:3},{value:"Detect task execution",id:"detect-task-execution",level:3},{value:"Correlate events",id:"correlate-events",level:3}];function l(e){const s={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.header,{children:(0,t.jsx)(s.h1,{id:"dectecting-suspicious-scheduled-tasks",children:"Dectecting suspicious scheduled tasks"})}),"\n",(0,t.jsx)(s.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.em,{children:"Scheduled tasks"})," are a legitimate feature in Windows, widely used for automating system operations.\r\nHowever, attackers often exploit this capability to maintain persistence, delay execution of malicious payloads, or perform stealthy actions post-compromise."]}),"\n",(0,t.jsx)(s.p,{children:"In this guide, we'll walk through how to detect the creation, modification, execution, and deletion of scheduled tasks using Sysmon logs ingested into Splunk.\r\nWe'll also demonstrate how to analyze these events to uncover potentially malicious behavior, empowering defenders with practical detection techniques."}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"execution-steps",children:"Execution steps"}),"\n",(0,t.jsx)(s.h3,{id:"create-a-suspicious-scheduled-task",children:"Create a suspicious scheduled task:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:'schtasks /create /tn "MaliciousTask" /tr "C:\\malware.exe" /sc once /st 12:00\n'})}),"\n",(0,t.jsxs)(s.p,{children:["This command creates a scheduled task named ",(0,t.jsx)(s.em,{children:"MaliciousTask"})," that will execute a suspicious binary ",(0,t.jsx)(s.code,{children:"malware.exe"})," once at ",(0,t.jsx)(s.code,{children:"12:00 PM"}),"."]}),"\n",(0,t.jsx)(s.h3,{id:"modify-an-existing-task",children:"Modify an existing task:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:'schtasks /change /tn "MaliciousTask" /tr "C:\\evil_script.ps1"\n'})}),"\n",(0,t.jsx)(s.p,{children:"This modifies the task to execute a different payload, indicating possible tampering or redirection to a more stealthy script."}),"\n",(0,t.jsx)(s.h3,{id:"execute-the-task",children:"Execute the task:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:'schtasks /run /tn "MaliciousTask"\n'})}),"\n",(0,t.jsx)(s.p,{children:"This command immediately runs the scheduled task, which can be a red flag for adversary-initiated execution."}),"\n",(0,t.jsx)(s.h3,{id:"delete-the-task",children:"Delete the task:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:'schtasks /delete /tn "MaliciousTask" /f\n'})}),"\n",(0,t.jsx)(s.p,{children:"Cleaning up by deleting the task may signal an attempt to cover tracks after malicious use."}),"\n",(0,t.jsx)(s.h2,{id:"log-analysis-in-splunk",children:"Log analysis in Splunk"}),"\n",(0,t.jsx)(s.h3,{id:"detect-task-creation",children:"Detect task creation"}),"\n",(0,t.jsx)(s.p,{children:"Use the following SPL query to identify new process creation events where schtasks.exe is involved:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:'index=sysmon_logs EventCode=1 Image="*schtasks.exe"\n'})}),"\n",(0,t.jsxs)(s.p,{children:["This search filters Sysmon ",(0,t.jsx)(s.em,{children:"Event ID 1 (Process Create)"})," for the ",(0,t.jsx)(s.code,{children:"schtasks.exe"})," binary, which is used to create or manage scheduled tasks."]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Logs from Splunk:"})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:'07/24/2025 11:56:59 PM\r\nLogName=Microsoft-Windows-Sysmon/Operational\r\nEventCode=1\r\nEventType=4\r\nComputerName=DESKTOP-R6K3C8S\r\nUser=NOT_TRANSLATED\r\nSid=S-1-5-18\r\nSidType=0\r\nSourceName=Microsoft-Windows-Sysmon\r\nType=Information\r\nRecordNumber=3176\r\nKeywords=None\r\nTaskCategory=Process Create (rule: ProcessCreate)\r\nOpCode=Info\r\nMessage=Process Create:\r\nRuleName: -\r\nUtcTime: 2025-07-25 06:56:59.914\r\nProcessGuid: {d6c4500c-2abb-6883-0108-000000000500}\r\nProcessId: 1444\r\nImage: C:\\Windows\\System32\\schtasks.exe\r\nFileVersion: 10.0.19041.1503 (WinBuild.160101.0800)\r\nDescription: Task Scheduler Configuration Tool\r\nProduct: Microsoft\xae Windows\xae Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: schtasks.exe\r\nCommandLine: schtasks  /create /tn "MaliciousTask" /tr "C:\\malware.exe" /sc once /st 12:00\r\nCurrentDirectory: C:\\Program Files\\SplunkUniversalForwarder\\bin\\\r\nUser: DESKTOP-R6K3C8S\\thait\r\nLogonGuid: {d6c4500c-068d-6883-dda2-070000000000}\r\nLogonId: 0x7A2DD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: MD5=76CD6626DD8834BD4A42E6A565104DC2,SHA256=013C013E0EFD13C9380FAD58418B7ACA8356E591A5CCEFFDB910F7D8B0AD28EF,IMPHASH=ECCE05491F2E8F279F4790BCB1318C05\r\nParentProcessGuid: {d6c4500c-1437-6883-6206-000000000500}\r\nParentProcessId: 1876\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: "C:\\Windows\\system32\\cmd.exe" \r\nParentUser: DESKTOP-R6K3C8S\\thait\n'})}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Event description:"})," A scheduled task named ",(0,t.jsx)(s.strong,{children:"MaliciousTask"})," was created to run ",(0,t.jsx)(s.code,{children:"malware.exe"}),".\r\nThis is often an early-stage action by an attacker to ensure persistent access or deferred execution."]}),"\n",(0,t.jsx)(s.h3,{id:"detect-task-modification",children:"Detect task modification"}),"\n",(0,t.jsx)(s.p,{children:"To identify suspicious task updates:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:'index=sysmon_logs EventCode=1 CommandLine="*change*" Image="*schtasks.exe"\n'})}),"\n",(0,t.jsxs)(s.p,{children:["Filters for process creation events where the command line includes ",(0,t.jsx)(s.strong,{children:"change"}),", indicating modification of existing tasks."]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Log from Splunk:"})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:'07/25/2025 12:00:15 AM\r\nLogName=Microsoft-Windows-Sysmon/Operational\r\nEventCode=1\r\nEventType=4\r\nComputerName=DESKTOP-R6K3C8S\r\nUser=NOT_TRANSLATED\r\nSid=S-1-5-18\r\nSidType=0\r\nSourceName=Microsoft-Windows-Sysmon\r\nType=Information\r\nRecordNumber=3199\r\nKeywords=None\r\nTaskCategory=Process Create (rule: ProcessCreate)\r\nOpCode=Info\r\nMessage=Process Create:\r\nRuleName: -\r\nUtcTime: 2025-07-25 07:00:15.263\r\nProcessGuid: {d6c4500c-2b7f-6883-1a08-000000000500}\r\nProcessId: 992\r\nImage: C:\\Windows\\System32\\schtasks.exe\r\nFileVersion: 10.0.19041.1503 (WinBuild.160101.0800)\r\nDescription: Task Scheduler Configuration Tool\r\nProduct: Microsoft\xae Windows\xae Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: schtasks.exe\r\nCommandLine: schtasks  /change /tn "MaliciousTask" /tr "C:\\evil_script.ps1"\r\nCurrentDirectory: C:\\Program Files\\SplunkUniversalForwarder\\bin\\\r\nUser: DESKTOP-R6K3C8S\\thait\r\nLogonGuid: {d6c4500c-068d-6883-dda2-070000000000}\r\nLogonId: 0x7A2DD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: MD5=76CD6626DD8834BD4A42E6A565104DC2,SHA256=013C013E0EFD13C9380FAD58418B7ACA8356E591A5CCEFFDB910F7D8B0AD28EF,IMPHASH=ECCE05491F2E8F279F4790BCB1318C05\r\nParentProcessGuid: {d6c4500c-1437-6883-6206-000000000500}\r\nParentProcessId: 1876\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: "C:\\Windows\\system32\\cmd.exe" \r\nParentUser: DESKTOP-R6K3C8S\\thait\n'})}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Event description:"})," The task's action was altered to point to ",(0,t.jsx)(s.code,{children:"evil_script.ps1"}),", which may indicate adversarial pivoting or an attempt to load a less detectable payload."]}),"\n",(0,t.jsx)(s.h3,{id:"detect-task-execution",children:"Detect task execution"}),"\n",(0,t.jsx)(s.p,{children:"Use this query to find when a scheduled task was manually triggered:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:'index=sysmon_logs EventCode=1 CommandLine="*run*" Image="*schtasks.exe"\n'})}),"\n",(0,t.jsxs)(s.p,{children:["Focuses on execution events where the scheduled task is manually run using the ",(0,t.jsx)(s.code,{children:"/run"})," flag."]}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Log from Splunk:"})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:'07/25/2025 12:02:12 AM\r\nLogName=Microsoft-Windows-Sysmon/Operational\r\nEventCode=1\r\nEventType=4\r\nComputerName=DESKTOP-R6K3C8S\r\nUser=NOT_TRANSLATED\r\nSid=S-1-5-18\r\nSidType=0\r\nSourceName=Microsoft-Windows-Sysmon\r\nType=Information\r\nRecordNumber=3212\r\nKeywords=None\r\nTaskCategory=Process Create (rule: ProcessCreate)\r\nOpCode=Info\r\nMessage=Process Create:\r\nRuleName: -\r\nUtcTime: 2025-07-25 07:02:12.183\r\nProcessGuid: {d6c4500c-2bf4-6883-2708-000000000500}\r\nProcessId: 4056\r\nImage: C:\\Windows\\System32\\schtasks.exe\r\nFileVersion: 10.0.19041.1503 (WinBuild.160101.0800)\r\nDescription: Task Scheduler Configuration Tool\r\nProduct: Microsoft\xae Windows\xae Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: schtasks.exe\r\nCommandLine: schtasks  /run /tn "MaliciousTask"\r\nCurrentDirectory: C:\\Program Files\\SplunkUniversalForwarder\\bin\\\r\nUser: DESKTOP-R6K3C8S\\thait\r\nLogonGuid: {d6c4500c-068d-6883-dda2-070000000000}\r\nLogonId: 0x7A2DD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: MD5=76CD6626DD8834BD4A42E6A565104DC2,SHA256=013C013E0EFD13C9380FAD58418B7ACA8356E591A5CCEFFDB910F7D8B0AD28EF,IMPHASH=ECCE05491F2E8F279F4790BCB1318C05\r\nParentProcessGuid: {d6c4500c-1437-6883-6206-000000000500}\r\nParentProcessId: 1876\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: "C:\\Windows\\system32\\cmd.exe" \r\nParentUser: DESKTOP-R6K3C8S\\thait\n'})}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"Event description:"})," ",(0,t.jsx)(s.strong,{children:"MaliciousTask"})," was manually executed, a behavior often observed in hands-on keyboard attacks or post-exploitation activities."]}),"\n",(0,t.jsx)(s.h3,{id:"correlate-events",children:"Correlate events"}),"\n",(0,t.jsx)(s.p,{children:"To map out the full attack sequence involving task operations"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:'index=sysmon_logs EventCode=1 Image="*schtasks.exe" OR EventCode=3\n'})}),"\n",(0,t.jsxs)(s.p,{children:["This query pulls both process creation (EventCode=1) and network connection logs (EventCode=3) for comprehensive visibility around ",(0,t.jsx)(s.code,{children:"schtasks.exe"})," activity."]}),"\n",(0,t.jsx)("div",{style:{width:"100%",margin:"0 auto"},children:(0,t.jsx)("img",{src:n(9145).A,style:{width:"100%",height:"auto"}})})]})}function h(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}}}]);